<!--
Get-Your is a platform for application and administration of income-
qualified programs, used primarily by the City of Fort Collins.
Copyright (C) 2022-2025

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
{% load static %}

<!DOCTYPE html>
<html lang="en">

{% include "partials/static-imports.html" with title="Get FoCo | Household" %}

<body class="bg-secondary">

    <!-- Page container -->
    <div class="container py-5 mt-4 mt-lg-5 mb-lg-4 my-xl-5">
        <div class="row pt-sm-2 pt-lg-0">
            <!-- Page content -->
            <div class="col-lg-12 pt-4 pb-2 pb-sm-4">
                <div class="card">
                    <div class="card-body">
                        <form id="household-members-form" method="post" action="{% url 'app:household_members' %}"
                            class="needs-validation" novalidate>

                            <div class="row mb-4">
                                <div class="col-5">
                                    {% include "partials/steps.html" with active_step="household"%}
                                </div>
                                <div class="col-7">
                                    <div class="row g-3">
                                        {% csrf_token %}

                                        <p class="mb-0 form-label">You indicated you had {{ dependent }} individual(s)
                                            in your household, what are their names and birthdates?</p>

                                        {% for number in list %}
                                        <div id="household_member_{{ number }}" class="household_member">
                                            <div class="mb-3">
                                                <label for="id_name" class="form-label">First &amp; Last Name of Individual:</label>
                                                <input type="text" name="name" id="id_name" class="form-control" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="id_birthdate" class="form-label">Their Birthdate:</label>
                                                <div class="position-relative">
                                                    <input id="id_birthdate" name="birthdate" class="form-control date-picker pe-5" type="text" placeholder="Choose date" data-datepicker-options='{"altInput": true, "altFormat": "F j, Y", "dateFormat": "Y-m-d"}' required>
                                                    <i class="gi-calendar position-absolute top-50 end-0 translate-middle-y me-3"></i>
                                                </div>
                                            </div>
                                            <input type="hidden" name="identification_path" id="id_identification_path" value="" style="display: none;">
                                            <button id="fileupload_{{ number }}" type="button" class="btn btn-primary file-upload-btn" data-household-member="{{number}}" style="display: block;">Upload ID</button>
                                        </div>
                                        {% endfor %}

                                    </div>
                                </div>

                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="{% url 'app:household' %}?app_status=in_progress"
                                    class="btn btn-primary">Back</a>
                                {% if update_mode or renewal_mode %}
                                <button class="btn btn-primary" type="submit"> Confirm </button>
                                {% else %}
                                <button class="btn btn-primary" type="submit"> Continue </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="{% static 'vendor/flatpickr/dist/flatpickr.min.css' %}">
    <script src="{% static 'vendor/flatpickr/dist/flatpickr.min.js' %}"></script>
    {% include "partials/footer.html" %}

    <script src="{% static 'vendor/sweetalert2/dist/sweetalert2.all.min.js' %}"></script>
    <script src="{% static 'vendor/moment/min/moment.min.js' %}"></script>
    

    <script>
        var update_mode = "{{ update_mode }}" === "True";
        var renewal_mode = "{{ renewal_mode }}" === "True";
        var formData = JSON.parse('{{ form_data | escapejs }}');

        document.addEventListener('DOMContentLoaded', function () {
            // Get all elements with id 'id_identification_path'
            let idIdentificationPathInputs = document.querySelectorAll("input[id='id_identification_path']");
            idIdentificationPathInputs.forEach(input => {
                input.value = "";
                input.style.display = "none";
            });

            // Get all labels for 'id_identification_path'
            let idIdentificationPathLabels = document.querySelectorAll("label[for='id_identification_path']");
            idIdentificationPathLabels.forEach(label => label.style.display = "none");

            // Hide all of the file-upload-btns
            let fileUploadBtns = document.querySelectorAll(".file-upload-btn");
            fileUploadBtns.forEach(btn => btn.style.display = "none");

            // For all of the .household_member divs, check to see if their inputs have values
            // If they do then show the corresponding file-upload-btn
            let householdMembers = document.querySelectorAll(".household_member");
            householdMembers.forEach(member => showFileUploadBtn(member.id));

            // Listen to all of the household_member_{{ number }} class child inputs
            // If the inputs have values then show the corresponding file-upload-btn
            document.querySelector("form").addEventListener('input', function (event) {
                if (event.target.parentElement.classList.contains('household_member')) {
                    showFileUploadBtn(event.target.parentElement.id);
                }
            });

            fileUploadBtns.forEach(btn => {
                btn.addEventListener('click', async function () {
                    // Get the nearest id_identification_path
                    let identification_path = this.parentElement.querySelector("input[id='id_identification_path']");
                    // Get the birthdate of the household member
                    let birthdate = this.parentElement.querySelector("input[id='id_birthdate']").value;
                    // Check if the birthdate is >= 18 years ago
                    let is_eighteen_or_older = moment().subtract(18, 'years').isAfter(birthdate);
                    let html = "";
                    if (is_eighteen_or_older) {
                        html = `<img src=\"{% static 'img/co_drivers_license_sample.png' %}\" alt=\"Sample Documents\" style=\"margin-bottom:15px\">
                    <p style=\"color:#13467D\">For accepted proof of identification, <a
                    href="https://drive.google.com/file/d/1eyJ4sMmoEw2_lLJFVFlAzQcNFk8oF2Lj/view"
                    style="color:var(--yellow)" target="_blank">please click here</a>
                    </p>`;
                    } else {
                        html = `<img src=\"{% static 'img/co_drivers_license_sample.png' %}\" alt=\"Sample Documents\" style=\"margin-bottom:15px\">
                    <p style=\"color:#13467D\">Child ID can include things like Free and Reduced Lunch, medical ID, student ID, or birth certificate. Please make sure the names are clear.
                    </p>`;
                    }

                    var { value: file } = await Swal.fire({
                        title: "Select image",
                        html: html,
                        input: "file",
                        confirmButtonColor: '#13467D',
                        inputAttributes: {
                            "accept": ".jpg, .png, .pdf",
                            "aria-label": "Upload your file"
                        }
                    });

                    if (file) {
                        var reader = new FileReader()
                        reader.onload = (e) => {
                            Swal.fire({
                                title: "Your uploaded file",
                                confirmButtonColor: '#13467D',
                                imageUrl: e.target.result,
                                imageAlt: "The uploaded file"
                            }).then((result) => {
                                // Set the background color of the file-upload-btn to green and
                                // change the text of the button to "Uploaded" and disable the button
                                this.style.backgroundColor = "green";
                                this.textContent = "File Uploaded";
                            });

                            // Set the value of the nearest id_identification_path to the file
                            // Encode the file contents as a Base64 string
                            var fileContent = e.target.result.split(",")[1];
                            identification_path.value = fileContent;
                        }

                        reader.readAsDataURL(file);
                    }
                });
            });

            // Listen for the form submit event. If the all of the id_identification_path inputs 
            // are empty then prevent the form from submitting. Also for each empty id_identification_path
            // color the corresponding Upload ID button red.
            document.querySelector("form").addEventListener('submit', function (event) {
                var empty_identification_paths = 0;
                householdMembers.forEach(member => {
                    var identification_path = member.querySelector("input[name='identification_path']").value;
                    if (identification_path === "") {
                        empty_identification_paths++;
                        member.querySelector(".file-upload-btn").style.backgroundColor = "red";
                    }
                });
                if (empty_identification_paths > 0) {
                    event.preventDefault();
                    Swal.fire({
                        title: 'Household Information',
                        text: 'Please upload a photo of your ID for each member of your household.',
                        icon: 'error',
                        confirmButtonText: 'Ok',
                        confirmButtonColor: '#13467D'
                    });
                }
            });
        });

        function showFileUploadBtn(household_member) {
            // Get the nearest name and birthday inputs for the household_member and check if they have values
            let nameInput = document.querySelector(`#${household_member} > div.mb-3 > input[name="name"]`);
            let birthdateInput = document.querySelector(`#${household_member} > div.mb-3 > div.position-relative > input[name="birthdate"]`);
            let fileUploadBtn = document.querySelector(`#${household_member} > .file-upload-btn`);
            if (nameInput.value !== "" && birthdateInput.value !== "") {
                fileUploadBtn.style.display = "block";
            } else {
                fileUploadBtn.style.display = "none";
            }
        }

        var household_names = document.getElementsByName("name");
        var household_birthdates = document.getElementsByName("birthdate");
        try {
            if (update_mode || renewal_mode) {
                // Check if the new number of household members is different from the old number of household members
                // If it is let the user know to check over the names and birthdates
                if (household_names.length !== formData.persons_in_household.length) {
                    Swal.fire({
                        title: 'Household Information',
                        text: 'The members of your household have changed since you last submitted your application. Please make sure their names and birthdays are up to date.',
                        icon: 'info',
                        confirmButtonText: 'Ok',
                        confirmButtonColor: '#13467D'
                    });
                }
            }

            for (var i = 0; i < household_names.length; i++) {
                if (formData.persons_in_household[i]) {
                    household_names[i].value = formData.persons_in_household[i].name;
                    household_birthdates[i].value = formData.persons_in_household[i].birthdate;
                }
            }
        } catch (error) {
            console.warn("User has no household members");
        }
    </script>
</body>

</html>