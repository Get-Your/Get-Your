<!--
Get-Your is a platform for application and administration of income-
qualified programs, used primarily by the City of Fort Collins.
Copyright (C) 2022-2025

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
{% load static %}

<!DOCTYPE html>
<html lang="en">

{% include "partials/static-imports.html" with title="Get FoCo | Account Setup" %}

<body class="bg-secondary">

    <!-- Page container -->
    <div class="container py-5 mt-4 mt-lg-5 mb-lg-4 my-xl-5">
        <div class="row pt-sm-2 pt-lg-0">
            <!-- Page content -->
            <div class="col-lg-12 pt-4 pb-2 pb-sm-4">
                {% if not update_mode %}
                <h1 class="h2 mb-4">Where do you live?</h1>
                {% endif %}

                <div class="card">
                    <div class="card-body">
                        <form id="address-form" method="post" action="{% url 'app:address' %}" class="needs-validation"
                            novalidate>

                            <div class="row mb-4">
                                <div class="col-5">
                                    {% include "partials/steps.html" with active_step="address"%}
                                </div>
                                <div class="col-7">
                                    <div class="row g-3">
                                    {% csrf_token %}
                                    <h5 class="h5">Home Address</h5>
                                    {% for field in eligibility_address_form %}
                                    {% if form.errors %}
                                    {% for error in field.errors %}
                                    <div class="alert alert-danger">
                                        <strong>{{ error|escape }}</strong>
                                    </div>
                                    {% endfor %}
                                    {% endif %}


                                        {% if not update_mode %}
                                        {% if field.label == "State" %}
                                        <!-- Add inputs for State and Zip Code -->
                                        <div class="col-md-6">
                                            <label for="{{ field.name }}" class="form-label">{{field.label}}</label>
                                            <input type="text" class="form-control" id="state"
                                                maxlength="{{ field.max_length }}" type="text"
                                                value="{{ field.value|default:'' }}" name="{{ field.name }}"
                                                autocomplete="off" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid {{field.label}}.
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="{{ eligibility_address_form.zip_code.name }}"
                                                class="form-label">Zip Code</label>
                                            <input type="text" class="form-control" id="zip_code"
                                                name="{{ eligibility_address_form.zip_code.name }}"
                                                value="{{ eligibility_address_form.zip_code.value|default:'' }}"
                                                pattern="[0-9]{5}" maxlength="5" required autocomplete="off">
                                            <div class="invalid-feedback">
                                                Please provide a valid Zip Code.
                                            </div>
                                        </div>
                                        {% elif field.label == "Zip Code" %}
                                        {% else %}
                                        <div class="col-12">
                                            <label for="{{ field.name }}" class="form-label">{{field.label}}</label>
                                            <input type="text" class="form-control" id="{{ field.id_for_label }}"
                                                maxlength="{{ field.max_length }}" type="text"
                                                value="{{ field.value|default:'' }}" name="{{ field.name }}"
                                                autocomplete="off" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid {{field.label}}.
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% endif %}
                                        {% endfor %}

                                        {% if not update_mode %}
                                        <!-- Is your mailing address the same as your home address? -->
                                        <div class="col-12">
                                            <p class="mb-0">Is your mailing address the same as your home address?</p>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="mailing_address" value="yes" checked>
                                                <label class="form-check-label" for="mailing_address1">
                                                    Yes
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="mailing_address" value="no">
                                                <label class="form-check-label" for="mailing_address2">
                                                    No
                                                </label>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <div id="mailing_address_wrapper">
                                            <h5 class="h5">Mailing Address</h5>
                                            <div class="row g-3">
                                            {% for field in mailing_address_form %}
                                            {% if field.label == "State" %}
                                            <div class="col-md-6">
                                                <label for="mailing_state" class="form-label">{{field.label}}</label>
                                                <input type="text" class="form-control" id="mailing_state"
                                                    maxlength="{{ field.max_length }}" type="text"
                                                    value="{{ field.value|default:'' }}" name="mailing_{{ field.name }}"
                                                    autocomplete="off" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="mailing_zip_code" class="form-label">Zip Code</label>
                                                <input type="text" class="form-control" id="mailing_zip_code"
                                                    name="mailing_{{ mailing_address_form.zip_code.name }}"
                                                    value="{{ mailing_address_form.zip_code.value|default:'' }}"
                                                    pattern="[0-9]{5}" maxlength="5" required autocomplete="off">
                                            </div>
                                            {% elif field.label == "Zip Code" %}
                                            {% else %}
                                            <div class="col-12">
                                                <label for="mailing_{{ field.name }}" class="form-label">{{field.label}}</label>
                                                <input type="text" class="form-control" id="mailing_{{ field.id_for_label }}"
                                                    maxlength="{{ field.max_length }}" type="text"
                                                    value="{{ field.value|default:'' }}" name="mailing_{{ field.name }}"
                                                    autocomplete="off" required>
                                                <div class="invalid-feedback">
                                                    Please provide a valid {{field.label}}.
                                                </div>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                            </div>
                                        </div>

                                    </div>
                                </div>

                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="{% url 'users:detail' pk=request.user.pk %}?app_status=in_progress"
                                    class="btn btn-primary">Back</a>
                                {% if update_mode or renewal_mode %}
                                <button class="btn btn-primary" type="submit"> Confirm </button>
                                {% else %}
                                <button class="btn btn-primary" type="submit"> Continue </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include "partials/footer.html" %}

    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var submitButton = document.querySelector("button[type=submit]");
            submitButton.addEventListener('click', function (e) {
                var spinner = document.createElement('div');
                spinner.classList.add('spinner-border', 'spinner-border-sm', 'ms-2');
                submitButton.appendChild(spinner);
            });

            {% if not update_mode %}
            var sameAddress = "{{ same_address }}" === "True";
            var mailingAddressWrapper = document.getElementById("mailing_address_wrapper");
            var mailingAddressHtml = mailingAddressWrapper.innerHTML;
            mailingAddressWrapper.innerHTML = "";

            var mailingAddressRadios = document.querySelectorAll('input[type=radio][name=mailing_address]');
            if (sameAddress) {
                document.querySelector('input[type=radio][name=mailing_address][value=yes]').checked = true;
            } else {
                document.querySelector('input[type=radio][name=mailing_address][value=no]').checked = true;
            }

            updateMailingAddressVisibility(mailingAddressHtml);

            mailingAddressRadios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    updateMailingAddressVisibility(mailingAddressHtml);
                });
            });
            {% endif %}
        });

        {% if not update_mode %}
        function updateMailingAddressVisibility(mailingAddressHtml) {
            var mailingAddressBtn = document.querySelector('input[type=radio][name=mailing_address]:checked').value;
            toggleMailingAddressVisibility(mailingAddressBtn, mailingAddressHtml);
        }

        function toggleMailingAddressVisibility(mailingAddressBtn, mailingAddressHtml) {
            var mailingAddressWrapper = document.getElementById("mailing_address_wrapper");
            if (mailingAddressBtn == 'yes') {
                mailingAddressWrapper.innerHTML = "";
            } else if (mailingAddressBtn == 'no') {
                mailingAddressWrapper.innerHTML = mailingAddressHtml;
            }
        }
        {% endif %}
    </script>
</body>

</html>
