<!--
Get-Your is a platform for application and administration of income-
qualified programs, used primarily by the City of Fort Collins.
Copyright (C) 2022-2025

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
{% load static %}

<!DOCTYPE html>
<html lang="en">

{% include "partials/static-imports.html" with title="Get FoCo | Account Setup" %}

<body class="bg-secondary">

    <!-- Page container -->
    <div class="container py-5 mt-4 mt-lg-5 mb-lg-4 my-xl-5">
        <div class="row pt-sm-2 pt-lg-0">
            <!-- Page content -->
            <div class="col-lg-12 pt-4 pb-2 pb-sm-4">
                {% if update_mode %}
                <h1 class="h2 mb-4">Update Your Account Information</h1>
                {% else %}
                <h1 class="h2 mb-4">Create an Account</h1>
                {% endif %}

                <div class="card">
                    <div class="card-body">
                        <form id="account-form" method="post" action="{% url 'app:account' %}" class="needs-validation"
                            novalidate>

                            <div class="row mb-4">
                                <div class="col-5">
                                    {% include "partials/steps.html" with active_step="account"%}
                                </div>
                                <div class="col-7">

                                    {% csrf_token %}
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="first_name" class="form-label">First name</label>
                                            <input type="text" class="form-control" id="first_name" name="first_name"
                                                value="{{ user.first_name }}" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid first name.
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="last_name" class="form-label">Last name</label>
                                            <input type="text" class="form-control" id="last_name" name="last_name"
                                                value="{{ user.last_name }}" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid last name.
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" name="email"
                                                value="{{ user.email }}" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid email address.
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="phone_number" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="phone_number" name="phone_number"
                                                value="{{ user.phone_number }}" required>
                                            <div class="invalid-feedback">
                                                Please provide a valid phone number.
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="password" class="form-label">Password</label>
                                            <input type="password" class="form-control" id="password" name="password"
                                                required>
                                            <div class="invalid-feedback">
                                                Please provide a valid password.
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label for="password2" class="form-label">Confirm Password</label>
                                            <input type="password" class="form-control" id="password2" name="password2"
                                                required>
                                            <div class="invalid-feedback">
                                                Please provide a valid password.
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <a href="{% url 'app:get_ready' %}" class="btn btn-primary">Back</a>
                                {% if update_mode or renewal_mode %}
                                <button class="btn btn-primary" type="submit"> Confirm </button>
                                {% else %}
                                <button class="btn btn-primary" type="submit"> Create </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include "partials/footer.html" %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("account-form").addEventListener("submit", function (e) {
                e.preventDefault();
                // Add a spinner to the button to indicate that the form is being submitted
                var submitButton = document.querySelector("button[type=submit]");
                submitButton.addEventListener('click', function () {
                    var spinner = document.createElement('div');
                    spinner.classList.add('spinner-border', 'spinner-border-sm', 'ms-2');
                    button.appendChild(spinner);
                });

                var xhr = new XMLHttpRequest();
                xhr.open("POST", this.action, true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var data = JSON.parse(xhr.responseText);
                        if (data.result === "success") {
                            alert("account created!");
                            window.location = "address";
                        } else if ("redirect" in data) {
                            window.location.href = data.redirect;
                        } else {
                            alert(data.message);
                        }
                    }
                };
                xhr.onerror = function () {
                    console.log(xhr.responseText);
                };
                xhr.send(new URLSearchParams(new FormData(document.getElementById("account-form"))).toString());
            });

            {% if not update_mode %}
            var myInput = document.getElementById("password");
            var myInput2 = document.getElementById("password2");
            {% endif %}

            // document.getElementById('phone_number').addEventListener('input', function (e) {
            //     var x = e.target.value.replace(/\D/g, '').match(/(\d{0, 3})(\d{0, 3})(\d{0, 4})/);
            //     e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
            // });
        });
    </script>
</body>

</html>